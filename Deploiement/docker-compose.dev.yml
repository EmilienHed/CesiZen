version: '3.8'

services:
  postgres-dev:
    image: postgres:latest
    container_name: postegres_db_CESIZen_dev
    restart: always
    environment:
      POSTGRES_USER: CesiZenAdm
      POSTGRES_PASSWORD: CesiZenAdm59!
      POSTGRES_DB: CesiZenDBDev
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
    networks:
      - backend-dev
      - traefik

  backend-dev:
    image: mcr.microsoft.com/dotnet/aspnet:9.0
    container_name: backend-dev
    working_dir: /app
#    volumes:
#      - ./backend/publish:/app
    expose:
      - "5000"
    environment:
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Host=postegres_db_CESIZen;Port=5432;Database=CesiZenDB;Username=CesiZenAdm;Password=CesiZenAdm59!
    depends_on:
      - postgres
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`rasphubert.ddns.net`) && PathPrefix(`/emilien-dev/api`)"
      - "traefik.http.middlewares.api-strip.stripprefix.prefixes=/emilien-dev/api"
      - "traefik.http.routers.api.middlewares=api-strip"
      - "traefik.http.services.api.loadbalancer.server.port=8080"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=le"
    networks:
      - backend-dev
      - traefik
    command: ["dotnet", "Backend.dll"]



  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend-dev
    expose:
      - "4000"  # SSR Angular Ã©coute ici
    depends_on:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.front.rule=Host(`rasphubert.ddns.net`) && PathPrefix(`/emilien-dev`)"
      - "traefik.http.services.front.loadbalancer.server.port=80"
      - "traefik.http.routers.front.entrypoints=websecure"
      - "traefik.http.routers.front.tls.certresolver=le"
    networks:
      - frontend-dev
      - traefik

volumes:
  postgres_dev_data:

networks:
  backend-dev:
  frontend-dev:
  traefik:
    external: true
